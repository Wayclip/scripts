while ! pg_isready -h "$$PGHOST" -U "$$PGUSER"; do
  echo "[Cleanup] Waiting for database..."
  sleep 10
done
echo "[Cleanup] Database ready, starting cleanup loop..."
while true; do
  echo "[Cleanup] Running cleanup task for accounts older than 14 days..."
  psql -v ON_ERROR_STOP=1 --host "$$PGHOST" --username "$$PGUSER" --dbname "$$PGDATABASE" <<-EOSQL
    DO \$$
    DECLARE
        user_count INT;
    BEGIN
        WITH users_to_delete AS (
            SELECT id FROM users WHERE deleted_at <= NOW() - INTERVAL '14 days'
        )
        SELECT count(*) INTO user_count FROM users_to_delete;
        RAISE NOTICE '[Cleanup] Found % user(s) to permanently delete.', user_count;

        IF user_count > 0 THEN
            RAISE NOTICE '[Cleanup] Deleting clips...';
            DELETE FROM clips WHERE user_id IN (SELECT id FROM users_to_delete);

            RAISE NOTICE '[Cleanup] Deleting recovery codes...';
            DELETE FROM user_recovery_codes WHERE user_id IN (SELECT id FROM users_to_delete);

            RAISE NOTICE '[Cleanup] Deleting credentials...';
            DELETE FROM user_credentials WHERE user_id IN (SELECT id FROM users_to_delete);
            
            RAISE NOTICE '[Cleanup] Deleting user records...';
            DELETE FROM users WHERE id IN (SELECT id FROM users_to_delete);

            RAISE NOTICE '[Cleanup] Deletion complete for % user(s).', user_count;
        END IF;
    END;
    \$$;
EOSQL
  echo "[Cleanup] Task complete. Waiting 24 hours."
  sleep 86400
done
