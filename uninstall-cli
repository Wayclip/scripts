#!/usr/bin/env bash
set -euo pipefail

INSTALL_DIR="${WAYCLIP_INSTALL_DIR:-$HOME/.local/bin}"
SERVICE_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
BINARIES=(
  "${INSTALL_DIR}/wayclip-cli"
  "${INSTALL_DIR}/wayclip-daemon"
  "${INSTALL_DIR}/wayclip-trigger"
)
SERVICE_FILE="${SERVICE_DIR}/wayclip-daemon.service"

Color_Off=''
Red=''
Green=''
Dim=''
Bold_White=''
Yellow=''

if [[ -t 1 ]]; then
  Color_Off='\033[0m'
  Red='\033[0;31m'
  Green='\033[0;32m'
  Dim='\033[0;2m'
  Bold_White='\033[1m'
  Yellow='\033[0;33m'
fi

info() { echo -e "${Dim}$*${Color_Off}"; }
info_bold() { echo -e "${Bold_White}$*${Color_Off}"; }
success() { echo -e "${Green}$*${Color_Off}"; }
warn() { echo -e "${Yellow}warning${Color_Off}: $*"; }

info_bold "Wayclip Uninstaller"
echo
info "This script will attempt to remove Wayclip binaries and user services from your system."
info "The following specific files will be targeted for removal:"
info "  - Binaries: ${INSTALL_DIR}/wayclip-*"
info "  - Service:  ${SERVICE_FILE}"
echo

read -p "$(echo -e "${Bold_White}Are you sure you want to proceed with uninstallation? [y/N] ${Color_Off}")" response < /dev/tty
if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
  info "Uninstallation cancelled by user."
  exit 0
fi
echo

info "--> Stopping and disabling the Wayclip daemon service..."
if systemctl --user is-active --quiet wayclip-daemon.service; then
  systemctl --user stop wayclip-daemon.service
  success "Service stopped."
fi
if systemctl --user is-enabled --quiet wayclip-daemon.service; then
  systemctl --user disable wayclip-daemon.service
  success "Service disabled."
fi

info "--> Removing systemd service file..."
if [[ -f "$SERVICE_FILE" ]]; then
  rm -f "$SERVICE_FILE"
  success "Removed: ${SERVICE_FILE}"
else
  info "Service file not found, skipping."
fi

info "--> Reloading systemd user daemon..."
systemctl --user daemon-reload >/dev/null 2>&1 || true

info "--> Removing binaries..."
for bin in "${BINARIES[@]}"; do
  if [[ -f "$bin" ]]; then
    rm -f "$bin"
    success "Removed: ${bin}"
  else
    info "Binary not found, skipping: ${bin}"
  fi
done

echo
case ":$PATH:" in
  *":$HOME/.local/bin:"*)
    warn "\$HOME/.local/bin is still in your PATH."
    warn "If you no longer use it for other applications, you can remove this line"
    warn "from your shell configuration file (e.g., ~/.bashrc, ~/.zshrc, or ~/.profile):"
    info_bold "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    ;;
  *) : ;;
esac

echo
success "Wayclip has been successfully uninstalled."
