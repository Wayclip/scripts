#!/usr/bin/env bash
set -euo pipefail

INSTALL_DIR="${WAYCLIP_INSTALL_DIR:-$HOME/.local/bin}"
SERVICE_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/systemd/user"
BINARIES=(
    "${INSTALL_DIR}/wayclip-cli"
    "${INSTALL_DIR}/wayclip-daemon"
    "${INSTALL_DIR}/wayclip-trigger"
)
SERVICE_FILE="${SERVICE_DIR}/wayclip-daemon.service"

Color_Off='' Red='' Green='' Dim='' Bold_White='' Yellow=''
if [[ -t 1 ]]; then
    Color_Off='\033[0m'
    Red='\033[0;31m'
    Green='\033[0;32m'
    Dim='\033[0;2m'
    Bold_White='\033[1m'
    Yellow='\033[0;33m'
fi

info() { echo -e "${Dim}$*${Color_Off}"; }
info_bold() { echo -e "${Bold_White}$*${Color_Off}"; }
success() { echo -e "${Green}$*${Color_Off}"; }
warn() { echo -e "${Yellow}warning${Color_Off}: $*"; }
error() { echo -e "${Red}error${Color_Off}: $*" >&2; }

info_bold "Wayclip Uninstaller"
echo
info "This script will remove Wayclip binaries and services from your system:"
info "  - Binaries: ${INSTALL_DIR}/wayclip-*"
info "  - Service:  ${SERVICE_FILE}"
echo

read -rp "$(echo -e "${Bold_White}Proceed with uninstallation? [y/N] ${Color_Off}")" response </dev/tty
if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    info "Uninstallation cancelled."
    exit 0
fi
echo

info "--> Stopping and disabling Wayclip daemon service..."
if systemctl --user is-active --quiet wayclip-daemon.service; then
    systemctl --user stop wayclip-daemon.service && success "Service stopped."
fi
if systemctl --user is-enabled --quiet wayclip-daemon.service; then
    systemctl --user disable wayclip-daemon.service && success "Service disabled."
fi

info "--> Removing systemd service file..."
if [[ -f "$SERVICE_FILE" ]]; then
    rm -f "$SERVICE_FILE"
    success "Removed: ${SERVICE_FILE}"
else
    info "Service file not found, skipping."
fi

info "--> Reloading systemd user daemon..."
systemctl --user daemon-reload >/dev/null 2>&1 || true

# Remove binaries
info "--> Removing binaries..."
for bin in "${BINARIES[@]}"; do
    if [[ -f "$bin" ]]; then
        rm -f "$bin"
        success "Removed: ${bin}"
    else
        info "Binary not found, skipping: ${bin}"
    fi
done

if command -v zsh >/dev/null 2>&1 && [[ -n "${ZSH_VERSION:-}" ]]; then
    rehash
elif command -v bash >/dev/null 2>&1 && [[ -n "${BASH_VERSION:-}" ]]; then
    hash -r
fi

echo
success "Wayclip has been successfully uninstalled."
